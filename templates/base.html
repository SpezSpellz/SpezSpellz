<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="{% block favicon %}/assets/favicon.ico{% endblock %}">
    <title>{% block Title %}{% endblock %}</title>
</head>
<link rel="stylesheet" href="/assets/base.css">

<!--Messages go here-->
{% if messages %}
    <ul class="messages">
        {% for message in messages %}
            <li>{% if message.tags %}{% endif %}{{ message }}</li>
        {% endfor %}
    </ul>
{% endif %}
{% block BeforeBody %}
{% endblock %}
<body>
{% block Body %}
{% endblock %}
    <div class="left-top-btns">
        {% if request.resolver_match.url_name != 'home' %}
        <a href="{% url 'spezspellz:home' %} " class="btn-like left-top-btn">
            <img width="32" src="/assets/home.svg"/>
        </a>
        {% endif %}
        <a href="{% url 'spezspellz:upload' %}" class="btn-like left-top-btn">
            <img width="32" src="/assets/upload.svg"/>
        </a>
    </div>
    <div class="right-top-btns">
        {% if request.resolver_match.url_name == 'profile' %}
        <a id="bell_button" class="btn-like right-top-btn" onclick="popup()">
            <img width="32" src="/assets/bell.svg"/>
            <span class="badge" id="notif_count"></span>
        </a>
        <div id="popup_box" class="popup"></div>
        <a href="{% url 'spezspellz:usersettings' %}" class="btn-like right-top-btn"><img width="32" src="/assets/cog.svg"/></a>
        <form action="{% url 'logout' %}?next={% url 'spezspellz:home' %}" method="POST">
            {% csrf_token %}
            <input type="image" alt="Logout" name="submit" width="32" class="btn-like right-top-btn" src="/assets/logout.svg"/>
        </form>
        {% else %}
        {% if user.is_authenticated %}
        {% if request.resolver_match.url_name == 'home' %}
        <a id="bell_button" class="btn-like right-top-btn" onclick="popup()">
            <img width="32" src="/assets/bell.svg"/>
            <span class="badge" id="notif_count"></span>
        </a>
        <div id="popup_box" class="popup"></div>
        {% endif %}
        <a href="{% url 'spezspellz:profile' %}" class="btn-like right-top-btn"><img width="32" src="/assets/profile.svg"/></a>
        {% elif request.resolver_match.url_name != 'login' %}
        <a href="{% url 'login' %}?next={% url 'spezspellz:home' %}" class="btn-like right-top-btn"><img width="32" src="/assets/login.svg"/></a>
        {% endif %}
        {% endif %}
    </div>
</body>
{% block AfterBody %}
{% endblock %}
<script>
    if ("Notification" in window &&Notification.permission !== "granted")
        Notification.requestPermission().then(() => {});
    {% if user.userinfo.timed_notification %}
    if (localStorage.getItem("unread_count") == null){
        localStorage.setItem("unread_count", "0");
    }
    if (localStorage.getItem("noti_array") == null){
        localStorage.setItem("noti_array", JSON.stringify([]));
    }
    const badge = window.document.getElementById("notif_count");
    const popup_box = window.document.getElementById("popup_box");
    let notifications = {};
    let unread_count = localStorage.getItem("unread_count");
    popup = () => {
        if (popup_box != null) {
            if (popup_box.style.display === "block") {
                popup_box.style.display = "none";
            } else {
                popup_box.style.display = "block";
            }
        }
    }
    window.create_li = (noti_id) => {
        if (popup_box != null) {
            const noti = JSON.parse(localStorage.getItem(noti_id));
            const ref = document.createElement("a");
            ref.href = `/spell/${noti.ref}`
            const noti_box = document.createElement("div");
            noti_box.classList.add("popup-notif");
            const img = document.createElement("img");
            img.classList.add("popup-img");
            img.src = noti.icon;
            const info = document.createElement("div");
            const title = document.createElement("p");
            title.classList.add("popup-title");
            title.innerText = noti.title;
            const message = document.createElement("p");
            message.classList.add("popup-message");
            message.innerText = noti.message;
            const time = document.createElement("p");
            time.classList.add("popup-time");
            time.innerText = new Date(noti.time).toLocaleString(
                "en-US",
                {
                    year: 'numeric',
                    month: 'long',
                    hour: 'numeric',
                    minute: 'numeric',
                    day: 'numeric',
                    hour12: true
                }
            );
            popup_box.append(ref);
            ref.append(noti_box);
            noti_box.append(img);
            noti_box.append(info);
            info.append(title);
            info.append(message);
            info.append(time);
        }
    }
    window.update_badge = (unread_count) => {
        if (badge != null) {
            if (unread_count > 0) {
                badge.innerText = unread_count.toString();
                badge.style.display = "block";
            } else {
                badge.style.display = "none";
            }
        }
    }
    window.refetch_noti = () => {
        fetch("{% url 'spezspellz:usersettings' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                method: "get_noti",
                time: new Date(Date.now()).toISOString()
            })
        }).then(response => response.json())
            .then(data => notifications = data)
            .catch(() => {});
    }
    update_storage = (noti, bookmark, cur_time) => {
        localStorage.setItem(
            noti.noti_id.toString(),
            JSON.stringify({
                "title": bookmark.title,
                "message": noti.message,
                "icon": bookmark.icon,
                "time": cur_time,
                "ref": noti.spell_id
            })
        )
        let a = JSON.parse(localStorage.getItem("noti_array"));
        a.push(noti.noti_id);
        localStorage.setItem("noti_array", JSON.stringify(a));
        window.create_li(noti.noti_id.toString());
        unread_count++;
    }
    if (JSON.parse(localStorage.getItem("noti_array")).length !== 0){
        for (const noti_id of JSON.parse(localStorage.getItem("noti_array"))){
            window.create_li(noti_id.toString());
        }
    }
    window.refetch_noti();
    window.update_badge(unread_count)
    setInterval(() => {
        const cur_time = new Date(Date.now());
        if(notifications.last_notified == null)
            notifications.last_notified = new Date(0);
        for(const bookmark of notifications.bookmarks) {
            for(const noti of bookmark.notifications) {
                const date = new Date(noti.time);
                switch(noti.every) {
                    case 'D': {
                        const cur_year = cur_time.getFullYear();
                        const cur_month = cur_time.getMonth();
                        const cur_date = cur_time.getDate();
                        const new_date = new Date(date);
                        new_date.setFullYear(cur_year);
                        new_date.setMonth(cur_month);
                        const new_old_date = new Date(new_date);
                        new_date.setDate(cur_date);
                        new_old_date.setDate(cur_date);
                        if(notifications.last_notified <= new_date && new_date <= cur_time ||
                            notifications.last_notified <= new_old_date && new_old_date <= cur_time) {
                            update_storage(noti, bookmark, cur_time);
                            const n = new Notification(bookmark.title, {
                                body: noti.message,
                                icon: bookmark.icon
                            });
                        }
                        break;
                    }
                    case 'W': {
                        const cur_year = cur_time.getFullYear();
                        const cur_month = cur_time.getMonth();
                        const cur_date = cur_time.getDate();
                        const cur_day = cur_time.getDay();
                        const new_date = new Date(date);
                        new_date.setFullYear(cur_year);
                        new_date.setMonth(cur_month);
                        const new_old_date = new Date(new_date);
                        new_date.setDate(cur_date-cur_day+new_date.getDay())
                        new_old_date.setDate(cur_date-cur_day-7+new_date.getDay())
                        if(notifications.last_notified <= new_date && new_date <= cur_time ||
                            notifications.last_notified <= new_old_date && new_old_date <= cur_time) {
                            update_storage(noti, bookmark, cur_time);
                            const n = new Notification(bookmark.title, {
                                body: noti.message,
                                icon: bookmark.icon
                            });
                        }
                        break;
                    }
                    case 'M': {
                        const cur_year = cur_time.getFullYear();
                        const cur_month = cur_time.getMonth();
                        const new_date = new Date(date);
                        new_date.setFullYear(cur_year);
                        const new_old_date = new Date(new_date);
                        new_date.setMonth(cur_month);
                        new_old_date.setMonth(cur_month - 1);
                        if(notifications.last_notified <= new_date && new_date <= cur_time ||
                            notifications.last_notified <= new_old_date && new_old_date <= cur_time) {
                            update_storage(noti, bookmark, cur_time);
                            const n = new Notification(bookmark.title, {
                                body: noti.message,
                                icon: bookmark.icon
                            });
                        }
                        break;
                    }
                    case 'Y': {
                        const cur_year = cur_time.getFullYear();
                        const new_date = new Date(date);
                        new_date.setFullYear(cur_year);
                        const new_old_date = new Date(date);
                        new_old_date.setFullYear(cur_year - 1);
                        if(notifications.last_notified <= new_date && new_date <= cur_time ||
                            notifications.last_notified <= new_old_date && new_old_date <= cur_time) {
                            update_storage(noti, bookmark, cur_time);
                            const n = new Notification(bookmark.title, {
                                body: noti.message,
                                icon: bookmark.icon
                            });
                        }
                        break;
                    }
                    case 'S': {
                        if(notifications.last_notified <= date && date <= cur_time) {
                            update_storage(noti, bookmark, cur_time);
                            const n = new Notification(bookmark.title, {
                                body: noti.message,
                                icon: bookmark.icon
                            });
                        }
                        break;
                    }
                }
            }
        }
        notifications.last_notified = cur_time;
        window.update_badge(unread_count);
        localStorage.setItem("unread_count", unread_count.toString());
    }, 1000);
    {% endif %}
</script>
</html>